<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>伦敦地铁状态 · 站台屏</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/icon-152.png">
<style>
  body{margin:0;background:#000;color:#ff9a00;font:18px/1.4 -apple-system,Helvetica,Arial;}
  .top{padding:10px;border-bottom:1px solid #222;display:-webkit-box;display:-webkit-flex;display:flex;
       -webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;
       -webkit-box-align:center;-webkit-align-items:center;align-items:center}
  .title{font-weight:bold}
  .ctrl{background:#000;color:#ffcf7f;border:1px solid #333;border-radius:6px;padding:6px 8px}
  .bar{color:#ffcf7f;font-size:14px;padding:8px 10px;border-bottom:1px dashed #222}
  .row{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;align-items:center;padding:10px 8px;border-bottom:1px dashed #222}
  .idx{width:40px}
  .dest{-webkit-box-flex:1;-webkit-flex:1;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .eta{width:80px;text-align:right}
  .muted{color:#777}
  .searchBox{display:-webkit-box;display:-webkit-flex;display:flex;gap:8px;padding:10px;border-bottom:1px solid #222}
  .input{flex:1;background:#000;border:1px solid #333;border-radius:6px;color:#ffcf7f;padding:8px}
  .suggest{padding:4px 10px;border-bottom:1px dashed #222;max-height:40vh; overflow:auto; -webkit-overflow-scrolling:touch;}
  .sitem{padding:0;border:1px solid #222;border-radius:6px;margin:6px 0}
  .sitem a{display:block;padding:10px 12px;text-decoration:none;color:inherit}
  .badge{color:#ffcf7f;font-size:12px}
  .platHead{padding:4px 10px;color:#ffcf7f;background:#0a0a0a;border-top:1px solid #222;border-bottom:1px dashed #222}

  /* 线路状态区 */
  .linesBar{padding:8px 10px;border-bottom:1px dashed #222}
  .linesWrap{display:-webkit-box;display:-webkit-flex;display:flex;gap:8px;flex-wrap:wrap}
  .lineCard{border:1px solid #333;border-radius:8px;padding:8px 10px;min-width:160px;max-width:48%;
            background:#0a0a0a;color:#ffcf7f}
  .lineName{font-weight:bold;font-size:14px;margin-bottom:4px}
  .lineStat{font-size:12px;color:#ffd7a1}
  .clickable{cursor:pointer}
  .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #444}

  /* 线路品牌色（轻量点缀，卡片仍保持深色背景） */
  .bakerloo .pill{border-color:#B36305}
  .central .pill{border-color:#E32017}
  .circle .pill{border-color:#FFD300}
  .district .pill{border-color:#00782A}
  .hammersmith-city .pill{border-color:#F3A9BB}
  .jubilee .pill{border-color:#A0A5A9}
  .metropolitan .pill{border-color:#9B0056}
  .northern .pill{border-color:#000000}
  .piccadilly .pill{border-color:#003688}
  .victoria .pill{border-color:#0098D4}
  .waterloo-city .pill{border-color:#95CDBA}
  .elizabeth .pill{border-color:#69439A}

  /* 弹窗 */
  .modalMask{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none;z-index:999}
  .modal{position:absolute;left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);
         background:#0b0b0b;border:1px solid #333;border-radius:10px;max-width:90%;width:520px;color:#ffcf7f}
  .modalHd{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;
           -webkit-box-align:center;-webkit-align-items:center;align-items:center;padding:10px 12px;border-bottom:1px solid #222}
  .modalBd{padding:12px;font-size:14px;line-height:1.5;color:#ffd7a1;max-height:60vh;overflow:auto;-webkit-overflow-scrolling:touch;}
  .xbtn{border:1px solid #444;border-radius:6px;padding:4px 8px;color:#ffcf7f;background:#000;cursor:pointer}
</style>

<div class="top">
  <div class="title">伦敦地铁状态</div>
  <div>
    <label>显示</label>
    <select id="limit" class="ctrl"><option>3</option><option>5</option><option selected>8</option><option>10</option><option>15</option><option>20</option></select>
    <label>站台</label>
    <select id="platformSel" class="ctrl"><option value="">全部站台</option></select>
    <button id="openBoard" class="ctrl">站台屏</button>
    <button id="fs" class="ctrl">全屏</button>
  </div>
</div>

<div class="searchBox">
  <input id="q" class="input" placeholder="输入站名（Hammersmith / King's Cross / Waterloo / Liverpool Street）">
  <button id="go" class="ctrl">搜索</button>
</div>
<div id="suggest" class="suggest"></div>

<div class="bar">
  站点：<span id="station">-</span>　时间：<span id="clock">--:--:--</span>
</div>

<!-- 新增：线路状态栏（在站点与站台之间） -->
<div class="linesBar" id="linesBar" style="display:none">
  <div style="color:#ffcf7f;font-size:14px;margin-bottom:6px">线路状态</div>
  <div class="linesWrap" id="linesWrap"></div>
</div>

<div id="list"></div>

<!-- 弹窗 -->
<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="modalHd">
      <div id="modalTitle">线路状态</div>
      <button class="xbtn" id="modalClose">×</button>
    </div>
    <div class="modalBd" id="modalBody"></div>
  </div>
</div>

<script>
(function(){
  // —— 工具
  function qs(k){var m=location.search.match(new RegExp('[?&]'+k+'=([^&]+)'));return m?decodeURIComponent(m[1]):'';}
  function pad(n){n=String(n);return n.length<2?('0'+n):n;}
  function nowstr(){var d=new Date();return [pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');}
  function clean(s){return (s||'').replace(/\s*\(?Underground Station\)?/gi,'').replace(/\s+/g,' ').replace(/^\s+|\s+$/g,'');}
  function fetchJSON(url, cb){var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.onreadystatechange=function(){if(xhr.readyState===4){try{cb(null,JSON.parse(xhr.responseText));}catch(e){cb(e);}}};xhr.send(null);}

  // —— DOM
  var id=qs('id')||'';
  var limitSel=document.getElementById('limit');
  var platformSel=document.getElementById('platformSel');
  var stationEl=document.getElementById('station');
  var listEl=document.getElementById('list');
  var qInput=document.getElementById('q');
  var suggEl=document.getElementById('suggest');
  var linesBar=document.getElementById('linesBar');
  var linesWrap=document.getElementById('linesWrap');
  var modalMask=document.getElementById('modalMask');
  var modalClose=document.getElementById('modalClose');
  var modalTitle=document.getElementById('modalTitle');
  var modalBody=document.getElementById('modalBody');

  // —— 线路缓存
  var stationLines = []; // [{id,name}]
  var platformsCache = {}; // { [stationId]: [ {name,count}, ... ] }

  // —— 线路卡片 & 弹窗
  function setModal(title, html){
    modalTitle.innerHTML = title || '线路状态';
    modalBody.innerHTML = html || '';
    modalMask.style.display='block';
  }
  function hideModal(){ modalMask.style.display='none'; }
  modalClose.onclick = hideModal;
  modalMask.onclick = function(e){ if(e.target===modalMask) hideModal(); };

  // —— 线路状态栏触摸滚动防误触
  var linesDragging = false, linesTouchX = 0, linesTouchY = 0, linesListenersBound = false;

  function linesOnTouchStart(e){
    var t = e.touches ? e.touches[0] : null; if(!t) return;
    linesDragging = false; linesTouchX = t.clientX; linesTouchY = t.clientY;
  }
  function linesOnTouchMove(e){
    var t = e.touches ? e.touches[0] : null; if(!t) return;
    if (Math.abs(t.clientX - linesTouchX) > 8 || Math.abs(t.clientY - linesTouchY) > 8){
      linesDragging = true;
    }
  }
  function handleLineTap(e){
    // 如果刚刚发生了滑动，就不触发点击
    if (linesDragging){ linesDragging = false; return; }
    var t = e.target || e.srcElement;
    while(t && (!t.getAttribute || !t.getAttribute('data-line'))){ t = t.parentNode; }
    if(!t) return;
    var cls = t.className || '';
    if (cls.indexOf('clickable') < 0) return; // 只有非 Good Service 才弹窗
    var name = t.getAttribute('data-name') || '';
    var reason = t.getAttribute('data-reason'); reason = reason ? decodeURIComponent(reason) : '';
    if (!reason) return;
    setModal(name + ' · 线路信息', reason.replace(/\n/g,'<br>'));
  }

  function statusTextOf(lineObj){
    // 兼容多种返回形态
    if(!lineObj) return '';
    if(lineObj.statusSeverityDescription) return lineObj.statusSeverityDescription;
    if(lineObj.status && lineObj.status.description) return lineObj.status.description;
    if(lineObj.lineStatuses && lineObj.lineStatuses[0]){
      return lineObj.lineStatuses[0].statusSeverityDescription || lineObj.lineStatuses[0].statusSeverity || '';
    }
    return lineObj.state || '';
  }
  function reasonTextOf(lineObj){
    if(!lineObj) return '';
    if(lineObj.reason) return lineObj.reason;
    if(lineObj.lineStatuses && lineObj.lineStatuses[0] && lineObj.lineStatuses[0].reason) return lineObj.lineStatuses[0].reason;
    return '';
  }

  function renderLineCards(lineList, statusMap){
    // lineList: [{id,name}]；statusMap: { lineId: {statusSeverityDescription,reason,...} }
    linesWrap.innerHTML='';
    if(!lineList || !lineList.length){ linesBar.style.display='none'; return; }
    var frag='';
    for(var i=0;i<lineList.length;i++){
      var ln=lineList[i], lid=(ln.id||'').toLowerCase();
      var st=statusMap && statusMap[lid] || {};
      var statTxt=statusTextOf(st) || 'Good Service';
      var reason=reasonTextOf(st);
      var clickable = (statTxt && statTxt.toLowerCase()!=='good service' && reason);
      frag += '<div class="lineCard '+lid+(clickable?' clickable':'')+'" data-line="'+lid+'" data-name="'+(ln.name||'')+'" data-reason="'+(reason?encodeURIComponent(reason):'')+'">'
           +    '<div class="lineName"><span class="pill">'+(ln.name||lid)+'</span></div>'
           +    '<div class="lineStat">'+statTxt+'</div>'
           +  '</div>';
    }
    linesWrap.innerHTML = frag;
    linesBar.style.display='block';

  // 仅绑定一次监听，避免重复绑定导致多次触发
  if (!linesListenersBound) {
    if (linesWrap.addEventListener) {
      // 触摸滚动阈值
      linesWrap.addEventListener('touchstart', linesOnTouchStart, false);
      linesWrap.addEventListener('touchmove', linesOnTouchMove, false);
      // tap 触发（touchend）与鼠标点击
      linesWrap.addEventListener('touchend', handleLineTap, false);
      linesWrap.addEventListener('click', handleLineTap, false);
    } else {
      // 老浏览器兜底
      linesWrap.onclick = handleLineTap;
    }
    linesListenersBound = true;
  }

  function fetchLineStatus(lineIds, cb){
    if(!lineIds || !lineIds.length){ cb({}); return; }
    var u='/api/line-status?ids='+encodeURIComponent(lineIds.join(','));
    fetchJSON(u, function(err, data){
      var map = {};
      try{
        // 支持数组或对象返回
        var arr = data && (data.lines || data) || [];
        if(arr && arr.length){
          for(var i=0;i<arr.length;i++){
            var obj=arr[i], key=(obj.id||obj.lineId||'').toLowerCase();
            if(!key) continue;
            map[key]=obj;
          }
        }else{
          // 若返回是 { lineId: {...} }
          for(var k in data){ if(data.hasOwnProperty(k)) map[k.toLowerCase()] = data[k]; }
        }
      }catch(e){}
      cb(map);
    });
  }

  function fetchStationLinesById(stationId, cb){
    // 1) 优先尝试你项目的 /api/station-lines?id=
    var tried=false;
    function fallback(){
      if(tried) return; tried=true;
      // 2) 退化尝试 /api/lines-at?id=
      fetchJSON('/api/lines-at?id='+encodeURIComponent(stationId)+'&_='+Date.now(), function(e2,j2){
        var arr=(j2 && (j2.lines||j2))||[];
        var list=[];
        for(var i=0;i<arr.length;i++){
          var x=arr[i];
          var lid=(x.id||x.lineId||'')||'';
          var nm=x.name||x.commonName||x.lineName||lid;
          if(lid) list.push({id:lid,name:nm});
        }
        cb(list);
      });
    }
    fetchJSON('/api/station-lines?id='+encodeURIComponent(stationId)+'&_='+Date.now(), function(e,j){
      if(e || !j){ fallback(); return; }
      var arr=(j.lines||j)||[];
      if(!arr.length){ fallback(); return; }
      var list=[];
      for(var i=0;i<arr.length;i++){
        var x=arr[i]; var lid=(x.id||x.lineId||'')||''; var nm=x.name||x.commonName||x.lineName||lid;
        if(lid) list.push({id:lid,name:nm});
      }
      cb(list);
    });
  }

  function updateLineStatusUI(){
    if(!stationLines || !stationLines.length){ linesBar.style.display='none'; return; }
    var ids=stationLines.map(function(x){return (x.id||'').toLowerCase();}).filter(Boolean);
    fetchLineStatus(ids, function(map){ renderLineCards(stationLines, map); });
  }

  // —— 原列表渲染
  function render(entries,name,selectedPlatform){
    stationEl.innerHTML=name||id||'-';
    var html='';
    if(selectedPlatform){
      if(!entries.length)html='<div class="muted" style="padding:10px">暂无到站信息</div>';
      for(var i=0;i<entries.length;i++){
        var t=entries[i];
        html+='<div class="row"><div class="idx">'+(i+1)+'</div><div class="dest">'+clean(t.towards)+'</div><div class="eta">'+t.eta+'</div></div>';
      }
      listEl.innerHTML=html;return;
    }
    var groups={},order=[];
    for(var j=0;j<entries.length;j++){
      var p=entries[j].platform||'Platform';
      if(!groups[p]){groups[p]=[];order.push(p);}groups[p].push(entries[j]);
    }
    for(var g=0;g<order.length;g++){
      var pName=order[g];
      html+='<div class="platHead">站台：'+pName+'</div>';
      var arr=groups[pName];
      for(var k=0;k<arr.length;k++){
        var t2=arr[k];
        html+='<div class="row"><div class="idx">'+(k+1)+'</div><div class="dest">'+clean(t2.towards)+'</div><div class="eta">'+t2.eta+'</div></div>';
      }
    }
    listEl.innerHTML=html||'<div class="muted" style="padding:10px">暂无到站信息</div>';
  }

  function populatePlatforms(stationId, plats, keepSelection){
    var cached = platformsCache[stationId];
    if (cached && cached.length >= (plats||[]).length) { plats = cached; }
    else if (plats && plats.length) { platformsCache[stationId] = plats; }

    var curr=keepSelection ? platformSel.value : '';
    var htmlOpt='<option value="">全部站台</option>';
    for(var i=0;i<(plats||[]).length;i++){
      var p=plats[i];
      htmlOpt+='<option value="'+p.name+'">'+p.name+' ('+p.count+')</option>';
    }
    platformSel.innerHTML=htmlOpt;
    if (curr) platformSel.value = curr;
  }

  function refresh(){
    if(!id){ listEl.innerHTML='<div class="muted" style="padding:10px">请先搜索并选择车站</div>'; linesBar.style.display='none'; return; }
    var selectedPlat=platformSel.value||'';
    var params='id='+encodeURIComponent(id)+'&limit='+encodeURIComponent(limitSel.value);
    if (selectedPlat) params+='&platform='+encodeURIComponent(selectedPlat);
    var u='/api/platform?'+params+'&_='+Date.now();

    fetchJSON(u,function(err,j){
      if(err){ listEl.innerHTML='<div class="muted" style="padding:10px">加载失败</div>'; linesBar.style.display='none'; return; }
      var entries=(j&&j.entries)||[];
      var plats=(j&&j.availablePlatforms)||[];
      populatePlatforms(id, plats, true);
      render(entries, j&&j.stationName, selectedPlat);

      // 若没有 stationLines（比如 URL 直达），尝试按站点拉一次
      if(!stationLines || !stationLines.length){
        fetchStationLinesById(id, function(list){
          stationLines = list || [];
          updateLineStatusUI();
        });
      }else{
        updateLineStatusUI();
      }

      persistState();
    });
  }

  function searchStations(){
    var q=qInput.value||''; if(q.replace(/\s+/g,'').length<2){suggEl.innerHTML='<div class="muted">输入至少 2 个字符</div>';return;}
    var u='/api/search?q='+encodeURIComponent(q)+'&_='+Date.now();
    fetchJSON(u,function(err,j){
      if(err){suggEl.innerHTML='<div class="muted">搜索失败</div>';return;}
      var list=(j&&j.results)||[]; if(!list.length){suggEl.innerHTML='<div class="muted">无结果</div>';return;}
      var html=''; for(var i=0;i<list.length;i++){
        var s=list[i];var badge=(s.lines||[]).map(function(l){return l.name;}).join(' / ');
        html+='<div class="sitem"><a href="#" data-id="'+s.id+'" data-name="'+(s.name||'')+'" data-lines="'+encodeURIComponent(JSON.stringify(s.lines||[]))+'"><b>'+s.name+
              '</b><br><span class="badge">'+badge+'</span></a></div>';
      }
      suggEl.innerHTML=html;
    });
  }

  function persistState(){try{
    var obj={id:id||'',limit:parseInt(limitSel.value,10)||8,platform:platformSel.value||'',lines:stationLines||[]};
    localStorage.setItem('ios8_board_state',JSON.stringify(obj));
  }catch(e){}}
  try{
    var saved=localStorage.getItem('ios8_board_state');
    if(saved){
      var obj=JSON.parse(saved);
      if(!id&&obj.id)id=obj.id;
      if(obj.limit)limitSel.value=String(obj.limit);
      if(obj.platform)platformSel.value=obj.platform;
      if(obj.lines)stationLines=obj.lines;
    }
  }catch(e){}

  // —— 打开站台屏
  document.getElementById('openBoard').onclick=function(){
    if(!id){ alert('请先选择车站'); return; }
    var params='id='+encodeURIComponent(id)+'&limit='+encodeURIComponent(limitSel.value);
    var selectedPlat=platformSel.value||''; if(selectedPlat)params+='&platform='+encodeURIComponent(selectedPlat);
    location.href='/platform-board.html?'+params;
  };

  // —— 联想点击：带“滑动阈值”防误触，并携带 lines
  var touchStartX=0,touchStartY=0,isDragging=false;
  function onTouchStart(e){var t=e.touches?e.touches[0]:null; if(!t)return; touchStartX=t.clientX; touchStartY=t.clientY; isDragging=false;}
  function onTouchMove(e){var t=e.touches?e.touches[0]:null; if(!t)return; var dx=Math.abs(t.clientX-touchStartX), dy=Math.abs(t.clientY-touchStartY); if(dx>8 || dy>8){ isDragging=true; }}
  function handlePick(e){
    if(isDragging){ isDragging=false; return false; }
    e=e||window.event; var t=e.target||e.srcElement;
    while(t&&t.tagName&&t.tagName.toUpperCase()!=='A'){t=t.parentNode;} if(!t) return false;
    var sid=t.getAttribute('data-id'); var snm=t.getAttribute('data-name'); var ln=t.getAttribute('data-lines');
    if(sid){
      id=sid; stationEl.innerHTML=snm||sid; platformSel.value=''; suggEl.innerHTML='';
      // 保存 lines（来自搜索结果）
      try{ stationLines = JSON.parse(decodeURIComponent(ln||'%5B%5D')) || []; }catch(ex){ stationLines = []; }
      qInput.blur(); try{window.scrollTo(0,0);}catch(ex){}
      platformsCache[id]=undefined;
      refresh();
      if(e.preventDefault)e.preventDefault(); if(e.stopPropagation)e.stopPropagation();
      return false;
    }
  }
  if(suggEl.addEventListener){
    suggEl.addEventListener('touchstart',onTouchStart,false);
    suggEl.addEventListener('touchmove',onTouchMove,false);
    suggEl.addEventListener('touchend',handlePick,false);
    suggEl.addEventListener('click',function(e){handlePick(e);},false);
  }else{
    suggEl.onclick=handlePick;
  }

  // 其它事件与时钟
  document.getElementById('fs').onclick=function(){var de=document.documentElement;if(de.requestFullscreen)de.requestFullscreen();};
  document.getElementById('limit').onchange=function(){refresh();persistState();};
  document.getElementById('platformSel').onchange=function(){refresh();persistState();};
  document.getElementById('go').onclick=searchStations;
  document.getElementById('q').onkeyup=function(ev){var k=ev.keyCode||ev.which;if(k===13){searchStations();}};

  // 初始与定时
  if(id){refresh();} 
  setInterval(refresh,15000); 
  setInterval(function(){document.getElementById('clock').innerHTML=nowstr();},1000);
})();
</script>
