<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>站台屏</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="/icon-152.png">
<style>
  @font-face { font-family: 'StationLED'; src: url('/assets/fonts/Station/Station.ttf') format('truetype'); font-weight: normal; font-style: normal; }
  :root{ --fg:#ff9a00; --muted:#8a6a3a; }
  html,body{height:100%;}
  body{ margin:0;background:#000;color:var(--fg); font:18px/1.4 'StationLED', -apple-system, Helvetica, Arial; overflow:hidden; }
  .screen{position:relative; height:100%; padding:10px 14px; box-sizing:border-box;}
  .row{display:-webkit-box;display:-webkit-flex;display:flex; -webkit-box-align:center;-webkit-align-items:center;align-items:center;}
  .title{justify-content:center; font-size:42px; margin-top:4px;}
  .clock{text-align:center; font-size:32px; margin-top:30px;}
  .list{margin-top:16px;}
  .item{padding:10px 2px;}
  .num{width:36px;}
  .dest{-webkit-box-flex:1;-webkit-flex:1;flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:12px;}
  .eta{width:120px; text-align:right;}
  .muted{color:var(--muted)}
  .dotlike{text-shadow: 0 0 3px rgba(255,154,0,.7);}
  .searchBar{display:-webkit-box;display:-webkit-flex;display:flex;gap:6px;padding:6px 0 4px;border-bottom:1px solid #222}
  .input{flex:1;background:#000;border:1px solid #333;border-radius:6px;color:#ffcf7f;padding:8px}
  .ctrl{background:#000;color:#ffcf7f;border:1px solid #333;border-radius:6px;padding:6px 8px}
  .suggest{max-height:40%; overflow:auto; padding:4px 0; border-bottom:1px dashed #222}
  .sitem{padding:0;border:1px solid #222;border-radius:6px;margin:6px 0}
  .sitem a{display:block;padding:10px 12px;text-decoration:none;color:inherit}
  .subbar{margin-top:6px;display:-webkit-box;display:-webkit-flex;display:flex;gap:6px;align-items:center}
  .bannerRow{padding:10px 2px; text-align:center;}
  .blink{animation:blink 1s step-start infinite;} @keyframes blink {50%{opacity:.35;}}
</style>

<div class="screen">
  <div class="searchBar">
    <input id="q" class="input" placeholder="搜索站名">
    <button id="go" class="ctrl">搜索</button>
    <button id="back" class="ctrl">返回简洁版</button>
  </div>
  <div id="suggest" class="suggest"></div>

  <div class="subbar">
    <div>站台</div>
    <select id="platformSel" class="ctrl"><option value="">全部站台</option></select>
    <div>显示</div>
    <select id="limit" class="ctrl"><option>3</option><option selected>5</option><option>8</option><option>10</option></select>
  </div>

  <div class="row title dotlike">
    <div id="titleStation">-</div>
  </div>

  <div class="list" id="list"></div>

  <div class="clock dotlike" id="clock">--:--:--</div>
</div>

<script>
(function(){
  // —— 工具
  function qs(k){var m=location.search.match(new RegExp('[?&]'+k+'=([^&]+)'));return m?decodeURIComponent(m[1]):'';}
  function pad(n){n=String(n);return n.length<2?('0'+n):n;}
  function nowstr(){var d=new Date();return [pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');}
  function clean(s){return (s||'').replace(/\s*\(?Underground Station\)?/gi,'').replace(/\s+/g,' ').replace(/^\s+|\s+$/g,'');}
  function fetchJSON(url, cb){var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.onreadystatechange=function(){if(xhr.readyState===4){try{cb(null,JSON.parse(xhr.responseText));}catch(e){cb(e);}}};xhr.send(null);}

  // —— 元素 & 状态
  var id = qs('id')||'';
  var plat = qs('platform')||'';
  var limitSel = document.getElementById('limit');
  var platformSel = document.getElementById('platformSel');
  var clockEl = document.getElementById('clock');
  var titleEl = document.getElementById('titleStation');
  var listEl = document.getElementById('list');
  var qInput = document.getElementById('q'); var suggEl = document.getElementById('suggest');

  // —— 参数（可调）
  var APPROACH_SECS = 55;       // 触发阈值（秒）
  var ARRIVE_DURATION = 8000;   // STAND BACK 显示 8s
  var BASE_REFRESH = 15000;     // 常规刷新
  var BOOST_REFRESH = 5000;     // 接近时加速刷新 5s
  var BOOST_WINDOW  = 30000;    // 加速刷新 30s
  var RETRIGGER_COOLDOWN = 90000; // 同一“第一辆车”最多 90s 才允许再次触发一次

  var smokeTick=0; 
  var arriveShowUntil = 0;         // 当前提示窗口结束时间（到时自动隐藏）
  var approachBoostUntil = 0;      // 加速刷新到期时间
  var refreshTimer = null;

  // 为“第一辆车”生成一个稳定的 key（没有 trainId 时的替代）
  function leadKeyOf(e){
    if(!e) return '';
    var k = [
      e.trainId || e.vehicleId || '',
      e.lineId || e.line || '',
      e.platform || e.platformName || '',
      e.destinationName || '',
      e.towards || ''
    ].join('|').toLowerCase();
    return k;
  }
  var lastShownKey = '';     // 上一次触发时的“第一辆车”key
  var lastShownAt  = 0;      // 上一次触发时间戳

  // —— 从多种字段推导“剩余秒数”；最后再从 ETA 文案兜底
  function parseEtaToSecs(eta){
    if(!eta) return null;
    var s = String(eta).toLowerCase().trim();
    if (s === 'due' || s === 'arriving' || s === 'arrived') return 20;
    var m = s.match(/(\d+)\s*min/); if(m) return Math.max(0,(+m[1])*60);
    var s2 = s.match(/(\d+)\s*s(ec|econds?)?/); if(s2) return Math.max(0,(+s2[1]));
    return null;
  }
  function getSecs(e){
    var keys=['timeToStationSec','timeToStationSeconds','timeToStation','secondsToArrival','seconds'];
    for(var i=0;i<keys.length;i++){
      var v=e[keys[i]]; if(typeof v==='number' && isFinite(v)) return v;
    }
    if (e.expectedArrival){
      var t = Date.parse(e.expectedArrival);
      if (!isNaN(t)) return Math.round((t - Date.now())/1000);
    }
    if (e.eta != null) { var pv = parseEtaToSecs(e.eta); if (pv != null) return pv; }
    if (e.etaText != null) { var pv2 = parseEtaToSecs(e.etaText); if (pv2 != null) return pv2; }
    return null;
  }

  function isApproaching(entries){
    for(var i=0;i<entries.length;i++){
      var e = entries[i];
      var secs = getSecs(e);
      if (secs!==null && secs>=0 && secs<=APPROACH_SECS) return true;
      var loc = String(e.currentLocation||'').toLowerCase();
      if (loc && (loc.indexOf('approaching')>=0 || loc.indexOf('at platform')>=0 || loc.indexOf('arriv')>=0)) return true;
    }
    return false;
  }

  // —— 一次性触发：只在“首次进入接近状态”且通过去重条件时开窗；到期后不续命
  function tryStartArriveWindow(entries){
    if (!entries.length) return false;
    var lead = entries[0];
    var key  = leadKeyOf(lead);
    var now  = Date.now();

    // 只有满足“接近”才考虑开启
    if (!isApproaching(entries)) return false;

    // 同一第一辆车，90s 冷却内不重复触发
    if (key && key === lastShownKey && (now - lastShownAt) < RETRIGGER_COOLDOWN) return false;

    // 开启 8s 展示窗口，并记录本次“第一辆车”的 key
    arriveShowUntil = now + ARRIVE_DURATION;
    lastShownKey = key;
    lastShownAt  = now;

    // 同时开启 30s 加速刷新窗口
    if (now > approachBoostUntil) {
      approachBoostUntil = now + BOOST_WINDOW;
      restartRefreshLoop();
    }
    return true;
  }

  function smokingOn(){ return (smokeTick % 25) < 5; }

  function renderList(station, entries){
    titleEl.innerHTML = station + (plat ? (' — '+plat) : (platformSel.value?(' — '+platformSel.value):''));
    var html = '';
    var lim = parseInt(limitSel.value,10)||5;
    if(entries.length>lim) entries = entries.slice(0,lim);

    var now = Date.now();
    // 若窗口已到期，直接关闭；若未开启，尝试开启（一次性）
    if (now > arriveShowUntil) { arriveShowUntil = 0; }
    if (arriveShowUntil === 0) { tryStartArriveWindow(entries); }
    var showArrive = (arriveShowUntil && now <= arriveShowUntil);

    if (showArrive){
      // 第1行：首列车
      if (entries.length > 0){
        var t0 = entries[0];
        html += '<div class="row item dotlike"><div class="num">1</div><div class="dest">'+clean(t0.towards)+'</div><div class="eta">'+t0.eta+'</div></div>';
      } else {
        html += '<div class="row item dotlike"><div class="num">1</div><div class="dest muted">暂无到站信息</div><div class="eta"></div></div>';
      }
      // 第2行：进站标语（闪烁）；第3行留空（不显示编号）
      html += '<div class="bannerRow dotlike blink">STAND BACK — TRAIN APPROACHING</div>';
      listEl.innerHTML = html; return;
    }

    // 正常模式：第三位可能显示禁烟
    var smoke = smokingOn();
    for(var i=0;i<entries.length;i++){
      if (smoke && i===2){
        html += '<div class="bannerRow dotlike">NO SMOKING OR VAPING</div>';
        break;
      }
      var t = entries[i];
      html += '<div class="row item dotlike">'
            +   '<div class="num">'+(i+1)+'</div>'
            +   '<div class="dest">'+clean(t.towards)+'</div>'
            +   '<div class="eta">'+t.eta+'</div>'
            + '</div>';
    }
    listEl.innerHTML = html || '<div class="muted">暂无到站信息</div>';
  }

  function refresh(){
    if(!id){ listEl.innerHTML='<div class="muted">请先在上方搜索并选择车站</div>'; return; }
    var selPlat = platformSel.value || plat || '';
    var params='id='+encodeURIComponent(id)+'&limit='+encodeURIComponent(limitSel.value);
    if (selPlat) params += '&platform='+encodeURIComponent(selPlat);
    var u='/api/platform?'+params+'&_='+Date.now();
    fetchJSON(u, function(err, j){
      if (err || !j){ listEl.innerHTML='<div class="muted">加载失败</div>'; return; }
      var entries=(j.entries||[]);
      // 刷新站台下拉
      var plats=(j.availablePlatforms||[]), curr=platformSel.value||'';
      var htmlOpt='<option value="">全部站台</option>';
      for(var i=0;i<plats.length;i++){var p=plats[i]; htmlOpt+='<option value="'+p.name+'">'+p.name+' ('+p.count+')</option>';}
      platformSel.innerHTML=htmlOpt; if(curr){ platformSel.value=curr; } else if(plat){ platformSel.value=plat; }
      renderList(j.stationName||id, entries);
    });
  }

  // 自适应刷新频率
  function restartRefreshLoop(){
    if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    var now = Date.now();
    var interval = (now <= approachBoostUntil) ? BOOST_REFRESH : BASE_REFRESH;
    refreshTimer = setInterval(refresh, interval);
  }

  // —— 搜索（与 lite 页一致）
  function searchStations(){
    var q=qInput.value||''; if(q.replace(/\s+/g,'').length<2){suggEl.innerHTML='<div class="muted">输入至少 2 个字符</div>'; return; }
    var u='/api/search?q='+encodeURIComponent(q)+'&_='+Date.now();
    fetchJSON(u,function(err,j){
      if(err){suggEl.innerHTML='<div class="muted">搜索失败</div>';return;}
      var list=(j&&j.results)||[]; if(!list.length){suggEl.innerHTML='<div class="muted">无结果</div>';return;}
      var html=''; for(var i=0;i<list.length;i++){var s=list[i]; var badge=(s.lines||[]).map(function(l){return l.name;}).join(' / ');
        html+='<div class="sitem"><a href="#" data-id="'+s.id+'" data-name="'+(s.name||'')+'"><b>'+s.name+'</b><br><span class="badge">'+badge+'</span></a></div>'; }
      suggEl.innerHTML=html;
    });
  }
  function handlePick(e){
    e=e||window.event; var t=e.target||e.srcElement;
    while(t&&t.tagName&&t.tagName.toUpperCase()!=='A'){t=t.parentNode;} if(!t) return;
    var sid=t.getAttribute('data-id'); var snm=t.getAttribute('data-name');
    if(sid){ id=sid; plat=''; platformSel.value=''; suggEl.innerHTML=''; qInput.blur(); try{window.scrollTo(0,0);}catch(ex){}
      titleEl.innerHTML=snm||sid; arriveShowUntil=0; approachBoostUntil=0; lastShownKey=''; lastShownAt=0; restartRefreshLoop(); refresh();
      if(e.preventDefault)e.preventDefault(); if(e.stopPropagation)e.stopPropagation(); return false; }
  }

  document.getElementById('back').onclick=function(){
    var params = id ? ('?id='+encodeURIComponent(id)+'&limit='+encodeURIComponent(limitSel.value)+(platformSel.value?('&platform='+encodeURIComponent(platformSel.value)):'') ) : '';
    location.href = '/platform-lite.html'+params;
  };
  document.getElementById('go').onclick=searchStations;
  document.getElementById('q').onkeyup=function(ev){var k=ev.keyCode||ev.which;if(k===13){searchStations();}};
  if(suggEl.addEventListener){suggEl.addEventListener('touchstart',handlePick,false);suggEl.addEventListener('click',handlePick,false);}else{suggEl.onclick=handlePick;}
  platformSel.onchange=function(){arriveShowUntil=0; approachBoostUntil=0; restartRefreshLoop(); refresh();};
  limitSel.onchange=function(){refresh();};

  // 时钟与定时器
  clockEl.innerHTML=nowstr(); setInterval(function(){clockEl.innerHTML=nowstr();},1000);
  setInterval(function(){ smokeTick++; },1000);

  // 启动
  restartRefreshLoop();
  if(id){ refresh(); }
})();
</script>
